<!doctype html>
<html>

<head>
    <meta charset="utf-8" />
    <title>Admin — Decap CMS</title>
</head>

<body>
    <!-- Auth listener -->
    <script>
        console.log('Setting up auth listener...');

        window.addEventListener('message', function (e) {
            console.log('Message received:', e.data);

            if (typeof e.data === 'string' && e.data.indexOf('authorization:github:success:') === 0) {
                try {
                    const dataStr = e.data.replace('authorization:github:success:', '');
                    const authData = JSON.parse(dataStr);

                    console.log('Parsed auth data:', authData);

                    if (authData.token) {
                        // Lưu theo format Decap CMS
                        const user = {
                            token: authData.token,
                            backendName: 'github',
                            login: 'authenticated-user'
                        };

                        localStorage.setItem('netlify-cms-user', JSON.stringify(user));
                        console.log('Token saved successfully!');

                        // Reload để CMS load với token mới
                        setTimeout(function () {
                            window.location.reload();
                        }, 500);
                    }
                } catch (error) {
                    console.error('Auth processing error:', error);
                }
            }
        }, false);

        console.log('Auth listener ready');
    </script>

    <!-- Load Decap CMS -->
    <script>
        (function () {
            var script = document.createElement('script');
            script.src = '/admin/decap-cms.js';
            script.onload = function () { console.log('Loaded local decap-cms.js'); };
            script.onerror = function () {
                console.warn('Local decap-cms.js not found, fallback to jsDelivr');
                var s2 = document.createElement('script');
                s2.src = 'https://cdn.jsdelivr.net/npm/decap-cms@^3.0.0/dist/decap-cms.js';
                document.head.appendChild(s2);
            };
            document.head.appendChild(script);
        })();
    </script>
</body>

</html>